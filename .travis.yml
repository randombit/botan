language: cpp

os:
  - linux
  - osx

compiler:
  - clang
  - gcc

env:
  matrix:
    - BUILD_MODE="shared"
    - BUILD_MODE="static"
    - BUILD_MODE="coverage"
    - BUILD_MODE="sanitizer"

matrix:
  exclude:
    - os: osx
      compiler: gcc
    - compiler: clang
      env: BUILD_MODE="coverage"
    - compiler: clang
      env: BUILD_MODE="sanitizer"
# Limit coverity buid configurations to a minimum
# since coverity scan allows only 5 builds at once
    - env: COVERITY_SCAN_BRANCH=1 BUILD_MODE="sanitizer"
    - env: COVERITY_SCAN_BRANCH=1 BUILD_MODE="coverage"
    - env: COVERITY_SCAN_BRANCH=1
      os: osx

sudo: required

install:
  - ./src/scripts/ci/setup.sh

script:
  - echo "COVERITY_SCAN_BRANCH = ${COVERITY_SCAN_BRANCH}"
  - echo "COVERITY_SCAN_BRANCH_PATTERN = ${COVERITY_SCAN_BRANCH_PATTERN}"
  - if [ "${COVERITY_SCAN_BRANCH}" != 1 ]; then ./src/scripts/ci/build.sh ; fi

after_success:
  - ./src/scripts/ci/after_success.sh

notifications:
  email: lloyd@randombit.net

addons:
  coverity_scan:
    project:
      name: "randombit/botan"
    notification_email: lloyd@randombit.net
    build_command_prepend: "./configure.py"
    build_command: "make -j2"
    branch_pattern: coverity_scan
